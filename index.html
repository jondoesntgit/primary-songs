<!doctype html>
<html>
	<head>
		<title>Primary Songs</title>
		<script src="js/jquery.js"></script>
		<script src="js/bootstrap.min.js"></script>
		<script src="js/markdown.js"></script>
		<link rel="stylesheet" href="css/bootstrap.min.css">
		<script type="text/javascript" src="js/lunr.js"></script>	
		<style>
			.hidden { display: none; }
			.inputfile {
	width: 0.1px;
	height: 0.1px;
	opacity: 0;
	overflow: hidden;
	position: absolute;
	z-index: -1;
}

label {
    font-weight: normal !important;
    padding: 5;
}

h1 {
	text-align: center;
}

#song-viewer {
	font-size: 18px;
}

		</style>
	</head>
	<body>
	<nav class="navbar navbar-default">
	  <div class="container-fluid">
	    <div class="navbar-header">
	      <a class="navbar-brand">
	        Primary Songs
	      </a>
	    </div>

	    <button type="button" class="btn btn-default navbar-right navbar-btn">

	    <input class="inputfile" name="file" type="file" id="file" webkitdirectory="" directory="" />

	    <label for="file">
	    	Load Songs <span class="glyphicon glyphicon-open-file"></span>
	    </label>

	    </button>



		<form class="navbar-form navbar-right" role="search">
		  <div class="form-group">
		    <input id="search-bar" type="text" class="form-control" placeholder="Search">
		  </div>
		  <button type="submit" class="btn btn-default"><span class="glyphicon glyphicon-search" aria-hidden="true"></span></button>
		</form>

		<button type="button" id="list-all-button" class="btn btn-default  navbar-btn navbar-right">
    	List All <span class="glyphicon glyphicon-th-list"></span>
	    </button>
	  </div>



	</nav>


<div class="row search-row hidden" >
	<div class="col-sm-6">
		<ul id="search-results"></ul>
	</div>
	<div class="col-sm-6">
		<div id="song-previews"></div>
	</div>
</div>

<div class="row hidden" id="song-viewer" style="text-align: center;">
	<div >
		<div></div>
	</div>
</div>

</html>




<script>

var index = lunr(function () {
	this.field('title', {boost: 10})
	this.field('body')
	this.ref('id')
})

var store = [];

</script>


<script>
var content
if (window.File && window.FileReader && window.FileList && window.Blob) {
// Great success! All the File APIs are supported.
} else {
  alert('The File APIs are not fully supported in this browser.');
}


function showAllSongs() {

	$('#search-row').show();
	$('#search-results').show();
	$('#song-viewer').hide()
	$('#song-previews').empty();
	var resultdiv = $('ul#search-results');
	resultdiv.empty();
    for (var item in store) {
        var ref = store[item].id;
        var searchitem = '<li class="resultli" id="' + ref + '">' + store[ref].title + '</a></li>';
        resultdiv.append(searchitem);
    }
    resultdiv.show();	

    $('.resultli').bind({
    	click: function() {
    		$('#song-viewer').html(loadASong(this.id))
    			
    		$('#search-row').hide();
    		$('#search-results').hide();
    		$('#song-viewer').show()
    		$('#song-previews').empty();
    	},
    	mouseenter: function() {
    		$('#song-previews').html(markdown.toHTML(store[this.id].body))
    	},
    	mouseleave: function() {
    		$('#song-previews').empty();
    	}
	})
}

$(document).ready(function(){	
	$('#list-all-button').bind({
		click: showAllSongs
	})
});


// var $list = $('#list_of_files'); -->
var counter = 0;

$('#file').change(function(event) {
  $('.hidden').show().removeClass('hidden')
  $('#file-selector-div').hide()
  var listOfFiles = event.target.files;
  for (var i = 0, l = listOfFiles.length; i < l; ++i) {

  var reader = new FileReader();
  reader.onload = (function(theFile) {
  	return function(e) {
		  doc = {
  			id: counter,
  			title: theFile[counter].name
  		}
  		workingBody = e.target.result;
  		bodyLines = e.target.result.split('\n')
  		for (lineNumber = 0; lineNumber < bodyLines.length; lineNumber++) {
  			if (  				bodyLines[lineNumber].indexOf(':') > -1) {
  				l = bodyLines[lineNumber]
  				key = l.substring(0,l.indexOf(':'))
  				val = l.substring(l.indexOf(':')+1, l.length)
  				doc[key] = val
  			} else {
  				workingBody = bodyLines.slice(lineNumber, bodyLines.length).join('  \n')
  				break;
  			}
  		}

  		doc.body = workingBody
  		store [doc.id] = doc;
  		index.add(doc)
  		counter = counter + 1;
  	}
  })(listOfFiles)
     listOfFiles[i].i = i
     reader.readAsText(listOfFiles[i]);
  }
  alert('Loaded ' + i + ' songs!');
});



</script>

<script>

function loadASong (id) {
	var html = ""
	if (store[id].title.indexOf('.md') > -1) {
		;
	} else {
		html = html + '<h1>' + store[id].title + '</h1>';
	}
	html = html + markdown.toHTML(store[id].body)
	return html;
}


// Set up search

	$('#search-bar').on('keyup', function() {
		$('#search-row').show()
		$('#song-viewer').hide()
	    // Get query
	    var query = $(this).val();
	    // Search for it
	    var result = index.search(query);
	    // Output it
	    var resultdiv = $('ul#search-results');
	    if (result.length === 0) {
	        // Hide results
	        resultdiv.hide();
	    } else {
	        // Show results
	        resultdiv.empty();
	        for (var item in result) {
	            var ref = result[item].ref;
	            var searchitem = '<li class="resultli" id="' + ref + '">' + store[ref].title + '</a></li>';
	            resultdiv.append(searchitem);
	        }
	        resultdiv.show();	

	        $('.resultli').bind({
	        	click: function() {
	        		$('#song-viewer').html(loadASong(this.id))
	        			
	        		$('#search-row').hide();
	        		$('#search-results').hide();
	        		$('#song-viewer').show()
	        		$('#song-previews').empty();
	        	},
	        	mouseenter: function() {
	        		$('#song-previews').html(markdown.toHTML(store[this.id].body))
	        	},
	        	mouseleave: function() {
	        		$('#song-previews').empty();
	        	}


	        })


	    }
	})

</script>
